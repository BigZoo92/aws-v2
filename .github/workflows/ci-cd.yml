name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'

defaults:
  run:
    shell: bash

jobs:
  # -----------------------------
  # CI JOB : INSTALL + LINT + TEST + BUILD
  # -----------------------------
  setup:
    name: 📦 Setup environment & install deps (cached)
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🛠️ Setup Node.js & PNPM
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: ✨ Cache PNPM deps
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: 📆 Install deps
        run: pnpm install

  lint:
    name: 🧼 Lint
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
      - run: pnpm install
      - run: pnpm --filter frontend lint
      - run: pnpm --filter backend lint

  test:
    name: 🧪 Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
      - run: pnpm install
      - run: pnpm --filter frontend test
      - run: pnpm --filter backend test

  build:
    name: 🏗 Build + Docker
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
      - run: pnpm install
      - run: pnpm --filter frontend build
      - run: pnpm --filter backend build

      - name: 🐳 Docker build frontend
        run: docker build -f frontend/Dockerfile -t test-frontend .

      - name: 🐳 Docker build backend
        run: docker build -f backend/Dockerfile -t test-backend .

  # -----------------------------
  # CD JOBS : deploy depending on environment
  # -----------------------------
  deploy-dev:
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
      - name: Deploy to DEV
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            if [ ! -d ~/app-dev/.git ]; then
                rm -rf ~/app-dev
                git clone https://github.com/${{ github.repository }} ~/app-dev
            fi
            cd ~/app-dev
            git fetch origin
            git reset --hard origin/develop
            echo "POSTGRES_PORT=5434" > .env
            echo "BACKEND_PORT=3001" >> .env
            echo "FRONTEND_PORT=4001" >> .env
            echo "VITE_API_URL=http://54.246.79.227:3001" >> frontend/.env
            docker compose down
            docker compose up -d --build
          EOF

  deploy-preprod:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
      - name: Deploy to PREPROD
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            if [ ! -d ~/app-preprod/.git ]; then
                rm -rf ~/app-preprod
                git clone https://github.com/${{ github.repository }} ~/app-preprod
            fi
            cd ~/app-preprod
            git fetch origin
            git reset --hard origin/main
            echo "POSTGRES_PORT=5433" > .env
            echo "BACKEND_PORT=3002" >> .env
            echo "FRONTEND_PORT=4002" >> .env
            echo "VITE_API_URL=http://54.246.79.227:3002" >> frontend/.env
            docker compose down
            docker compose up -d --build
          EOF

  deploy-prod:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
      - name: Deploy to PROD
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            if [ ! -d ~/app-prod/.git ]; then
                rm -rf ~/app-prod
                git clone https://github.com/${{ github.repository }} ~/app-prod
            fi
            cd ~/app-prod
            echo "POSTGRES_PORT=5432" > .env
            echo "BACKEND_PORT=3004" >> .env
            echo "FRONTEND_PORT=4004" >> .env
            echo "VITE_API_URL=http://54.246.79.227:3004" >> frontend/.env
            echo "NODE_ENV=production"
            git fetch --all --tags
            git checkout ${{ github.ref_name }}
            docker compose down
            docker compose up -d --build
          EOF
